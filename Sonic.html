<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sonic Robber Run</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #222;
      display: flex;
      flex-direction: column;
      align-items: center;
      touch-action: none;
      user-select: none;
      -webkit-user-select: none;
    }
    canvas {
      background: #87CEEB;
      margin-top: 20px;
      border: 2px solid #000;
      image-rendering: pixelated;
      touch-action: none;
    }
    #touchControls {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 200px;
      pointer-events: none;
    }
    .touch-btn {
      position: absolute;
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid rgba(0, 0, 0, 0.5);
      border-radius: 10px;
      color: #fff;
      font-size: 20px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: auto;
      user-select: none;
      -webkit-user-select: none;
      touch-action: none;
    }
    .touch-btn:active {
      background: rgba(0, 0, 0, 0.5);
    }
    #jumpBtn {
      right: 10px;
      bottom: 10px;
      width: 80px;
      height: 80px;
    }
    #shootBtn {
      right: 100px;
      bottom: 10px;
      width: 80px;
      height: 80px;
    }
    #restartBtn {
      left: 50%;
      transform: translateX(-50%);
      bottom: 110px;
      width: 100px;
      height: 60px;
      display: none;
    }
    @media (max-width: 768px) {
      #touchControls {
        display: block;
      }
      canvas {
        width: 100vw;
        height: calc(100vh - 220px);
      }
    }
  </style>
</head>
<body>
  <canvas id="game" width="800" height="400"></canvas>
  <div id="touchControls">
    <div class="touch-btn" id="jumpBtn">▲</div>
    <div class="touch-btn" id="shootBtn">●</div>
    <div class="touch-btn" id="restartBtn">R</div>
  </div>

  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    const groundY = 340;

    // You (player)
    const player = {
      x: 80,
      y: groundY - 60,
      w: 40,
      h: 60,
      color: "blue",
      vy: 0,
      jumping: false,
      lastVy: 0      // remember previous frame velocity to know if falling
    };

    const enemies = [];
    function spawnEnemy() {
      enemies.push({
        x: canvas.width + Math.random() * 200,
        y: groundY - 40,
        w: 30,
        h: 40,
        color: "black",
        speed: 3 + Math.random() * 2
      });
    }
    for (let i = 0; i < 4; i++) spawnEnemy();

    // Bullets shot with space
    const bullets = [];

    let gameOver = false;
    
    // Game statistics
    let startTime = Date.now();
    let robbersShot = 0;
    let robbersStomped = 0;
    let robbersGotAway = 0;
    let bulletCount = 0;

    const keys = {};
    document.addEventListener("keydown", e => {
      if (e.code === "ArrowUp" || e.code === "Space") e.preventDefault();
      keys[e.code] = true;
      
      // Restart game with R key
      if (e.code === "KeyR" && gameOver) {
        restartGame();
      }
    });
    document.addEventListener("keyup", e => {
      keys[e.code] = false;
    });

    const BULLET_SPEED = 10;
    const ATTACK_COOLDOWN_FRAMES = 10;
    let attackCooldown = 0;

    function shootBullet() {
      bullets.push({
        x: player.x + player.w,
        y: player.y + player.h / 2 - 4,
        w: 12,
        h: 8,
        speed: BULLET_SPEED
      });
    }

    function handleInput() {
      if (gameOver) return;

      // Jump
      if ((keys["ArrowUp"] || keys["KeyW"]) && !player.jumping) {
        player.vy = -11;
        player.jumping = true;
      }

      // Space: shoot bullets, with a small cooldown (only if we have bullets)
      if (keys["Space"] && attackCooldown <= 0 && bulletCount > 0) {
        shootBullet();
        bulletCount--;
        attackCooldown = ATTACK_COOLDOWN_FRAMES;
      }
    }

    const gravity = 0.6;
    function updatePlayer() {
      if (gameOver) return;

      player.lastVy = player.vy;
      player.vy += gravity;
      player.y += player.vy;

      // Ground collision
      if (player.y + player.h >= groundY) {
        player.y = groundY - player.h;
        player.vy = 0;
        player.jumping = false;
      }
    }

    function updateEnemies() {
      if (gameOver) return;

      for (let e of enemies) {
        e.x -= e.speed;
        if (e.x + e.w < 0) {
          robbersGotAway++;
          e.x = canvas.width + Math.random() * 200;
          e.speed = 3 + Math.random() * 2;
        }
      }
    }

    function updateBullets() {
      for (let i = bullets.length - 1; i >= 0; i--) {
        const b = bullets[i];
        b.x += b.speed;
        if (b.x > canvas.width) {
          bullets.splice(i, 1);
        }
      }
    }

    // Helper: rectangle overlap
    function rectsOverlap(a, b) {
      return (
        a.x < b.x + b.w &&
        a.x + a.w > b.x &&
        a.y < b.y + b.h &&
        a.y + a.h > b.y
      );
    }

    function handleStompsAndTouches() {
      if (gameOver) return;

      for (let i = enemies.length - 1; i >= 0; i--) {
        const e = enemies[i];

        if (!rectsOverlap(player, e)) continue;

        const playerBottom = player.y + player.h;
        const enemyTop = e.y;

        // Stomp: player bottom is near enemy top AND player was moving down
        const stomping =
          player.lastVy > 0 &&
          playerBottom >= enemyTop &&
          playerBottom <= enemyTop + 15;

        if (stomping) {
          // Kill enemy and bounce player up
          robbersStomped++;
          bulletCount++;
          enemies.splice(i, 1);
          spawnEnemy();
          player.vy = -10;
          player.jumping = true;
        } else {
          // Hit from side/body: you die
          gameOver = true;
        }
      }
    }

    function handleBulletHits() {
      for (let i = bullets.length - 1; i >= 0; i--) {
        const b = bullets[i];
        for (let j = enemies.length - 1; j >= 0; j--) {
          const e = enemies[j];
          if (rectsOverlap(b, e)) {
            robbersShot++;
            bullets.splice(i, 1);
            enemies.splice(j, 1);
            spawnEnemy();
            break;
          }
        }
      }
    }

    function drawGround() {
      ctx.fillStyle = "green";
      ctx.fillRect(0, groundY, canvas.width, canvas.height - groundY);
    }

    function drawPlayer() {
      ctx.fillStyle = player.color;
      ctx.fillRect(player.x, player.y, player.w, player.h);

      ctx.fillStyle = "white";
      ctx.fillRect(player.x + 8, player.y + 10, 24, 20);

      ctx.fillStyle = "black";
      ctx.fillRect(player.x + 12, player.y + 16, 4, 4);
      ctx.fillRect(player.x + 24, player.y + 16, 4, 4);
    }

    function drawEnemies() {
      enemies.forEach(e => {
        ctx.fillStyle = e.color;
        ctx.fillRect(e.x, e.y, e.w, e.h);
        ctx.fillStyle = "white";
        ctx.fillRect(e.x + 5, e.y + 5, e.w - 10, 10);
        ctx.fillStyle = "black";
        ctx.fillRect(e.x + 5, e.y + 9, e.w - 10, 3);
      });
    }

    function drawBullets() {
      ctx.fillStyle = "yellow";
      bullets.forEach(b => {
        ctx.fillRect(b.x, b.y, b.w, b.h);
      });
    }
    
    function formatTime() {
      const timePlaying = Math.floor((Date.now() - startTime) / 1000);
      const minutes = Math.floor(timePlaying / 60);
      const seconds = timePlaying % 60;
      return `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
    
    function drawStats() {
      ctx.fillStyle = "black";
      ctx.font = "16px Arial";
      ctx.textAlign = "left";
      ctx.fillText(`Time: ${formatTime()}`, 10, 20);
      ctx.fillText(`Bullets: ${bulletCount}`, 10, 40);
      ctx.fillText(`Shot: ${robbersShot}`, 10, 60);
      ctx.fillText(`Stomped: ${robbersStomped}`, 10, 80);
      ctx.fillText(`Got Away: ${robbersGotAway}`, 10, 100);
    }

    function drawGameOver() {
      if (!gameOver) return;
      ctx.fillStyle = "rgba(0,0,0,0.5)";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "white";
      ctx.font = "40px Arial";
      ctx.textAlign = "center";
      ctx.fillText("GAME OVER", canvas.width / 2, canvas.height / 2 - 60);
      
      ctx.font = "20px Arial";
      ctx.fillText(`Time Played: ${formatTime()}`, canvas.width / 2, canvas.height / 2 - 10);
      ctx.fillText(`Robbers Shot: ${robbersShot}`, canvas.width / 2, canvas.height / 2 + 20);
      ctx.fillText(`Robbers Stomped: ${robbersStomped}`, canvas.width / 2, canvas.height / 2 + 50);
      ctx.fillText(`Robbers Got Away: ${robbersGotAway}`, canvas.width / 2, canvas.height / 2 + 80);
      
      ctx.font = "24px Arial";
      ctx.fillText("Press R to restart", canvas.width / 2, canvas.height / 2 + 130);
    }
    
    function restartGame() {
      // Reset player
      player.x = 80;
      player.y = groundY - 60;
      player.vy = 0;
      player.jumping = false;
      player.lastVy = 0;
      
      // Reset enemies
      enemies.length = 0;
      for (let i = 0; i < 4; i++) spawnEnemy();
      
      // Reset bullets
      bullets.length = 0;
      
      // Reset stats
      startTime = Date.now();
      robbersShot = 0;
      robbersStomped = 0;
      robbersGotAway = 0;
      bulletCount = 0;
      
      // Reset game state
      gameOver = false;
      attackCooldown = 0;
    }

    function loop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (attackCooldown > 0) attackCooldown--;

      handleInput();
      updatePlayer();
      updateEnemies();
      updateBullets();

      handleStompsAndTouches();
      handleBulletHits();

      drawGround();
      drawPlayer();
      drawEnemies();
      drawBullets();
      drawStats();
      drawGameOver();

      requestAnimationFrame(loop);
    }

    // Touch controls
    const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
    
    if (isTouchDevice) {
      const jumpBtn = document.getElementById("jumpBtn");
      const shootBtn = document.getElementById("shootBtn");
      const restartBtn = document.getElementById("restartBtn");
      
      jumpBtn.addEventListener("touchstart", (e) => {
        e.preventDefault();
        keys["ArrowUp"] = true;
      });
      
      jumpBtn.addEventListener("touchend", (e) => {
        e.preventDefault();
        keys["ArrowUp"] = false;
      });
      
      shootBtn.addEventListener("touchstart", (e) => {
        e.preventDefault();
        keys["Space"] = true;
      });
      
      shootBtn.addEventListener("touchend", (e) => {
        e.preventDefault();
        keys["Space"] = false;
      });
      
      restartBtn.addEventListener("touchstart", (e) => {
        e.preventDefault();
        if (gameOver) {
          restartGame();
        }
      });
    }
    
    // Show/hide restart button based on game state
    function updateRestartButton() {
      const restartBtn = document.getElementById("restartBtn");
      if (restartBtn) {
        restartBtn.style.display = gameOver ? 'flex' : 'none';
      }
    }
    
    // Update in game loop to show/hide restart button
    const originalLoop = loop;
    function loop() {
      updateRestartButton();
      originalLoop();
    }

    loop();
  </script>
</body>
</html>
